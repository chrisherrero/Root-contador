<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Contador de Root - Completo</title>
  
<style>
  :root{
    --bg-madera: #2c1d10;
    --panel: rgba(50,35,20,0.92);
    --acento: #dca45c;
    --boton: #d28b45;
    --boton-hover: #e59d52;
    --texto-claro: #f9f5f0;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    min-height:100vh;
    font-family: "Trebuchet MS", Arial, sans-serif;
    background: var(--bg-madera);
    color:var(--texto-claro);
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:1.2rem;
  }
  h1{ margin:0.5rem 0 1rem 0; text-shadow:2px 2px 3px #000; font-size:clamp(1.4rem,3.8vw,2rem); }

  /* Contenedor principal */
  .contenedor {
    width:100%;
    max-width:1100px;
  }

  /* Pantallas */
  .pantalla { display:none; }
  .activa { display:block; }

  /* Panel configuracion */
  .configuracion {
    background:var(--panel);
    padding:1rem;
    border-radius:12px;
    box-shadow:0 0 12px rgba(0,0,0,0.7);
  }
  .fila { display:flex; gap:1rem; align-items:center; flex-wrap:wrap; justify-content:space-between; }
  label{ font-weight:600; }
  select, input[type="number"], input[type="text"]{
    padding:0.45rem 0.6rem;
    border-radius:8px;
    border:none;
    font-size:1rem;
    background:rgba(255,255,255,0.95);
    color:#000;
  }
  .switch {
    display:flex;
    align-items:center;
    gap:0.6rem;
  }

  button{
    padding:0.6rem 1rem;
    border-radius:10px;
    border:none;
    background:var(--boton);
    color:white;
    cursor:pointer;
    box-shadow:2px 2px 6px rgba(0,0,0,0.6);
    transition:transform .12s ease, background .12s ease;
  }
  button:hover{ transform:scale(1.03); background:var(--boton-hover) }

  /* tablero selects - stacked 2 per row cuando espacio */
  .tablero {
    margin-top:1rem;
    display:grid;
    gap:1rem;
    grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
    width:100%;
  }

  .jugador {
    border-radius:14px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.55), inset 0 -2px 0 rgba(0,0,0,0.15);
    display:flex;
    flex-direction:column;
    gap:0.6rem;
    align-items:center;
    min-height:150px;
    padding:0.8rem;
    transition:transform .12s ease;
  }
  .jugador:hover{ transform: translateY(-3px); }

  .nombre-j {
    width:100%;
    text-align:center;
    font-weight:700;
    background: rgba(255,255,255,0.85);
    color:#000;
    padding:0.25rem;
    border-radius:6px;
    border:none;
  }

  .selector-row { display:flex; gap:0.6rem; width:100%; align-items:center; justify-content:center; }
  .selector-row select { max-width:220px; width:100%; }
  .alcance-valor { min-width:72px; text-align:center; padding:0.35rem 0.5rem; border-radius:8px; background:rgba(0,0,0,0.28); color:var(--texto-claro); font-weight:700; }

  .puntos {
    font-size:clamp(1.6rem,3.8vw,2.2rem);
    font-weight:900;
    text-shadow:1px 1px 2px rgba(0,0,0,0.8);
    color: #000;
    background: rgba(255,255,255,0.85);
    padding:0.3rem 0.8rem;
    border-radius:8px;
  }

  .mensaje-err { margin-top:0.8rem; color:#ffb3b3; font-weight:700; text-align:center; min-height:1.3rem }
  .alcance-act { margin-top:0.6rem; text-align:center; color:#bfe9ff; font-weight:700 }

  #iniciarBtn { margin:1rem auto 0; display:block; }
  #iniciarBtn:disabled { background:#6b6b6b; cursor:not-allowed; transform:none }

  /* Pantalla juego */
  .juego-area { margin-top:1rem; display:flex; flex-direction:column; gap:1rem; align-items:center; }
  .tablero-juego {
    display:grid;
    gap:1rem;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    width:100%;
  }
  .jugador-juego {
    border-radius:14px;
    padding:0.8rem;
    display:flex;
    flex-direction:column;
    align-items:center;
    gap:0.6rem;
    box-shadow: 0 6px 16px rgba(0,0,0,0.6);
    min-height:150px;
  }
  .nombre-juego {
    width:100%;
    text-align:center;
    font-weight:700;
    padding:0.25rem;
    border-radius:6px;
    border:none;
  }
/* Botones y layout de score en la pantalla de juego */
.botones {
  display:flex;
  align-items:center;
  justify-content:center;
  gap:0.6rem;
}

/* Botones: sin fondo blanco, símbolos grandes, color heredado */
.botones button {
  background: transparent;
  border: none;
  padding: 0.1rem 0.35rem;
  font-size: 2rem;        /* más grandes */
  font-weight: 900;
  line-height: 1;
  cursor: pointer;
  color: inherit;         /* para que el JS pueda setear color según contraste */
}

/* evitar el efecto de selección molesto en móviles */
.botones button:active { transform: scale(0.95); }

/* Puntos (ahora dentro del row) */
.puntos {
  min-width: 56px;
  text-align: center;
  font-size: clamp(1.6rem, 3.8vw, 2.2rem);
  font-weight: 900;
  background: transparent; /* ahora transparente: el color viene del card */
  color: inherit;
  padding: 0.15rem 0.4rem;
  border-radius: 6px;
}

  .ganador {
  position: fixed;
  left: 50%;
  top: 50%;
  transform: translate(-50%, -50%) scale(0);
  background: rgba(0, 0, 0, 0.85);
  color: #ffd700; /* dorado */
  padding: 1.5rem 2rem;
  border-radius: 16px;
  font-size: 1.5rem;
  font-weight: 900;
  text-align: center;
  display: none;
  box-shadow: 0 0 20px gold, 0 0 40px rgba(255, 215, 0, 0.4);
  z-index: 999;
  animation: popin 0.5s forwards;
}

.ganador.activo {
  display: block;
}

/* Animación pop-in */
@keyframes popin {
  0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
  60% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
  100% { transform: translate(-50%, -50%) scale(1); }
}
</style>
  
<link rel="icon" type="image/png" href="rootIcon/favicon-96x96.png" sizes="96x96" />
<link rel="icon" type="image/svg+xml" href="rootIcon/favicon.svg" />
<link rel="shortcut icon" href="rootIcon/favicon.ico" />
<link rel="apple-touch-icon" sizes="180x180" href="rootIcon/apple-touch-icon.png" />
<meta name="apple-mobile-web-app-title" content="MyWebSite" />
<link rel="manifest" href="rootIcon/site.webmanifest" />


</head>
<body>

<div class="contenedor">

  <!-- PANTALLA CONFIGURACION -->
  <div id="pantalla-config" class="pantalla activa">
    <h1>Contador de Root — Configuración</h1>
    <div class="configuracion">
      <div class="fila" style="align-items:center;">
        <div style="display:flex;gap:1rem;align-items:center;">
          <label for="numJugadores">Cantidad de jugadores</label>
          <select id="numJugadores">
            <option value="2">2</option>
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
            <option value="6">6</option>
          </select>

          <span style="margin-left:0.6rem;">Alcance mínimo:</span>
          <div id="alcanceMin" class="alcance-valor" style="background:rgba(0,0,0,0.28); color:#ffd86b;">21</div>
        </div>

        <div style="display:flex;gap:0.6rem;align-items:center">
          <label for="maxPuntos" style="margin-right:0.3rem;">Puntaje máximo</label>
          <input id="maxPuntos" type="number" value="30" min="1" max="100" style="width:86px">
        </div>
      </div>

      <div class="panel-config" style="margin-top:0.8rem; display:flex; justify-content:space-between; align-items:center;">
        <div style="flex:1">
        </div>

        <div style="display:flex;align-items:center;gap:1rem">
          <div class="switch">
            <label for="switchAlcance">Validar alcance</label>
            <input type="checkbox" id="switchAlcance" checked>
          </div>
          <button id="resetBtn">Reiniciar</button>
        </div>
      </div>

      <div id="tablero" class="tablero"></div>

      <div id="alcanceActual" class="alcance-act">Alcance actual: 0</div>
      <div id="mensajeError" class="mensaje-err"></div>

      <button id="iniciarBtn" disabled>Comenzar partida</button>
    </div>
  </div>

  <!-- PANTALLA JUEGO -->
  <div id="pantalla-juego" class="pantalla">
    <h1>Contador de Root — Partida</h1>
    <div class="configuracion juego-area">
      <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
        <div>
          <strong>Puntaje máximo:</strong> <span id="maxPuntosJuego">30</span>
        </div>
        <div>
          <button id="volverBtn">Volver</button>
        </div>
      </div>

      <div id="tableroJuego" class="tablero-juego"></div>

      <div id="mensajeGanador" class="ganador"></div>
    </div>
  </div>

</div>

<script>
/* Datos facciones (colores y alcances base) */
const facciones = [
  { nombre: "Marquesado", color: "#f7852a", alcanceBase: 10 },
  { nombre: "Nido de Águilas", color: "#325a9b", alcanceBase: 7 },
  { nombre: "Alianza del Bosque", color: "#6cc46d", alcanceBase: 3 },
  { nombre: "Vagabundo (B)", color: "#f7f7f7", alcanceBase: 5 }, // blanco
  { nombre: "Vagabundo (N)", color: "#111111", alcanceBase: 2 }, // negro (base 2, regla dinámica)
  { nombre: "Compañía del Río", color: "#5fc9e3", alcanceBase: 5 },
  { nombre: "Culto Reptiliano", color: "#f0e300", alcanceBase: 2 },
  { nombre: "Ducado Subterráneo", color: "#e6cfa7", alcanceBase: 8 },
  { nombre: "Conspiración Córvida", color: "#5c3a91", alcanceBase: 3 },
  { nombre: "Señor de los Cientos", color: "#e04b3e", alcanceBase: 9 },
  { nombre: "Guardianes de Hierro", color: "#555555", alcanceBase: 8 }
];

const alcanceMinimoPorJugadores = { 2:17, 3:18, 4:21, 5:25, 6:28 };

/* DOM */
const pantallaConfig = document.getElementById('pantalla-config');
const pantallaJuego = document.getElementById('pantalla-juego');
const numJugadoresSelect = document.getElementById('numJugadores');
const tablero = document.getElementById('tablero');
const alcanceMinDiv = document.getElementById('alcanceMin');
const alcanceActualDiv = document.getElementById('alcanceActual');
const mensajeErrorDiv = document.getElementById('mensajeError');
const iniciarBtn = document.getElementById('iniciarBtn');
const resetBtn = document.getElementById('resetBtn');
const switchAlcance = document.getElementById('switchAlcance');
const maxPuntosInput = document.getElementById('maxPuntos');

const tableroJuego = document.getElementById('tableroJuego');
const volverBtn = document.getElementById('volverBtn');
const maxPuntosJuegoSpan = document.getElementById('maxPuntosJuego');
const mensajeGanadorDiv = document.getElementById('mensajeGanador');

numJugadoresSelect.addEventListener('change', generarTablero);
resetBtn.addEventListener('click', generarTablero);
iniciarBtn.addEventListener('click', comenzarPartida);
// reemplazo: doble confirm estilo "¿Estás seguro?"
let volverConfirmando = false;
let volverTimeoutId = null;

volverBtn.addEventListener('click', () => {
  if (!volverConfirmando) {
    volverConfirmando = true;
    const originalText = volverBtn.textContent;
    volverBtn.textContent = '¿Estás seguro?';
    // volver al texto original pasados 3s si no se confirma
    volverTimeoutId = setTimeout(() => {
      volverConfirmando = false;
      volverBtn.textContent = originalText;
    }, 3000);
  } else {
    // si ya estaba en modo confirmación, hacemos la acción real
    if (volverTimeoutId) { clearTimeout(volverTimeoutId); volverTimeoutId = null; }
    volverConfirmando = false;
    volverBtn.textContent = 'Volver a configuración';
    // llamar a la función que ya tenías
    volverAConfig();
  }
});

/* util contraste */
function esColorOscuro(hex){
  hex = hex.replace('#','');
  const r = parseInt(hex.substring(0,2),16);
  const g = parseInt(hex.substring(2,4),16);
  const b = parseInt(hex.substring(4,6),16);
  const brillo = (r*299 + g*587 + b*114) / 1000;
  return brillo < 150;
}

/* genera selects por jugadores y preselecciona facciones únicas por orden */
function generarTablero(){
  const n = parseInt(numJugadoresSelect.value);
  alcanceMinDiv.textContent = alcanceMinimoPorJugadores[n];
  mensajeErrorDiv.textContent = '';
  iniciarBtn.disabled = true;
  tablero.innerHTML = '';

  // preselección única: las primeras n facciones del array
  const preseleccion = facciones.slice(0,n).map(f=>f.nombre);

  for(let i=0;i<n;i++){
    const card = document.createElement('div');
    card.className = 'jugador';

    // pintamos todo el card con color por defecto de la facción preseleccionada
    const facPre = facciones[i % facciones.length];
    card.style.background = facPre.color;
    // texto del nombre por defecto = nombre de la faccion
    const nombreInput = document.createElement('input');
    nombreInput.className = 'nombre-j';
    nombreInput.type = 'text';
    nombreInput.value = facPre.nombre;
    nombreInput.dataset.default = facPre.nombre;

    // selector y etiqueta alcance
    const selRow = document.createElement('div');
    selRow.className = 'selector-row';
    const select = document.createElement('select');
    select.id = `faccionSelect_${i}`;

    // construir opciones; para vagabundos mostramos (5/2) en la etiqueta
    const opciones = ['<option value="">-- Elegir facción --</option>'];
    facciones.forEach(f => {
      let label = `${f.nombre} (${f.alcanceBase})`;
      if(f.nombre === 'Vagabundo (B)' || f.nombre === 'Vagabundo (N)') {
        label = `${f.nombre} (5/2)`; // etiqueta informativa
      }
      opciones.push(`<option value="${f.nombre}">${label}</option>`);
    });
    select.innerHTML = opciones.join('');

    // preselección de la facción única por defecto
    if(preseleccion[i]) select.value = preseleccion[i];

    const alcanceLabel = document.createElement('div');
    alcanceLabel.className = 'alcance-valor';
    alcanceLabel.id = `alcVal_${i}`;
    alcanceLabel.textContent = '-';

    selRow.appendChild(select);
    selRow.appendChild(alcanceLabel);

    // puntos display (sólo visual en config)
    const puntosDiv = document.createElement('div');
    puntosDiv.className = 'puntos';
    puntosDiv.textContent = ''; // quitamos el 0 inútil

    // montar card
    card.appendChild(nombreInput);
    card.appendChild(selRow);
    card.appendChild(puntosDiv);
    tablero.appendChild(card);

    // evento select
    select.addEventListener('change', manejarCambio);
    // si se cambia el nombre a vacío, devolver al nombre por defecto (faccion) cuando cambie facción
    nombreInput.addEventListener('input', ()=>{ /* nada por ahora */ });
  }

  // actualizar todo
  manejarCambio();
}

/* obtiene array de nombres seleccionados en orden */
function obtenerSeleccionadas(){
  const selects = Array.from(document.querySelectorAll("select[id^='faccionSelect_']"));
  return selects.map(s=>s.value);
}

/* maneja cambios: evita duplicados, actualiza colores de card y alcances por select */
function manejarCambio(){
  const selects = Array.from(document.querySelectorAll("select[id^='faccionSelect_']"));
  const seleccionadas = selects.map(s => s.value).filter(v=>v && v.length>0);

  // deshabilitar duplicados (salvo en su propio select)
  selects.forEach(sel => {
    const valorActual = sel.value;
    Array.from(sel.options).forEach(opt => {
      if(opt.value === '') { opt.disabled = false; return; }
      if(opt.value !== valorActual && seleccionadas.includes(opt.value)) opt.disabled = true;
      else opt.disabled = false;
    });
  });

  // actualizar color de cada card y el texto del nombre (si es el nombre default lo actualiza al nombre de la faccion)
  selects.forEach((sel, idx) => {
    const val = sel.value;
    const card = sel.closest('.jugador');
    const nombreInput = card.querySelector('.nombre-j');
    if(val){
      const f = facciones.find(x=>x.nombre===val);
      card.style.background = f.color;
      // si el nombre coincide con el nombre por defecto anterior o está vacío, setear nombre por defecto
      if(!nombreInput.value || nombreInput.value === nombreInput.dataset.default) {
        nombreInput.value = f.nombre;
      }
      nombreInput.dataset.default = f.nombre;
      // colores de texto y puntos se adaptan para legibilidad
      nombreInput.style.color = esColorOscuro(f.color) ? '#fff' : '#000';
      nombreInput.style.background = esColorOscuro(f.color) ? 'rgba(255,255,255,0.12)' : 'rgba(255,255,255,0.85)';
      const puntosDiv = card.querySelector('.puntos');
      puntosDiv.style.color = esColorOscuro(f.color) ? '#fff' : '#000';
      puntosDiv.style.background = esColorOscuro(f.color) ? 'rgba(0,0,0,0.26)' : 'rgba(255,255,255,0.85)';
    } else {
      // sin selección: card neutro
      card.style.background = 'linear-gradient(135deg,#444,#222)';
      nombreInput.dataset.default = '';
    }
  });

  // recalcular alcance total y actualizar alcances por select (regla vagabundos)
  calcularAlcanceYActualizarUI();
}

/* calcula alcance total y fija el valor al lado de cada select */
function calcularAlcanceYActualizarUI(){
  const selects = Array.from(document.querySelectorAll("select[id^='faccionSelect_']"));
  const nombres = selects.map(s=>s.value);

  const idxVB = nombres.indexOf('Vagabundo (B)');
  const idxVN = nombres.indexOf('Vagabundo (N)');
  const hayVB = idxVB !== -1;
  const hayVN = idxVN !== -1;

  let total = 0;

  selects.forEach((sel, idx) => {
    const val = sel.value;
    const alcElem = document.getElementById(`alcVal_${idx}`);
    if(!val){ alcElem.textContent = '-'; return; }

    let f = facciones.find(x=>x.nombre === val);
    let alcanceAqui = f.alcanceBase;

    if(val === 'Vagabundo (B)' || val === 'Vagabundo (N)'){
      if(hayVB && hayVN){
        // ambos presentes -> primero en orden = 5, segundo = 2
        if(idxVB < idxVN){
          alcanceAqui = (val === 'Vagabundo (B)') ? 5 : 2;
        } else {
          alcanceAqui = (val === 'Vagabundo (N)') ? 5 : 2;
        }
      } else {
        // solo uno -> 5
        alcanceAqui = 5;
      }
    }

    alcElem.textContent = alcanceAqui;
    total += alcanceAqui;
  });

  const n = parseInt(numJugadoresSelect.value);
  const minReq = alcanceMinimoPorJugadores[n];
  alcanceActualDiv.textContent = `Alcance actual: ${total} / ${minReq}`;

  const faltan = nombres.some(v=>!v || v.length===0);
  const validarAlcance = switchAlcance.checked;

  if(faltan){
    mensajeErrorDiv.textContent = '⚠️ Faltan jugadores por asignar.';
    iniciarBtn.disabled = true;
  } else if(validarAlcance && total < minReq){
    mensajeErrorDiv.textContent = `⚠️ Alcance mínimo requerido: ${minReq}. (actual ${total})`;
    iniciarBtn.disabled = true;
  } else {
    mensajeErrorDiv.textContent = '';
    iniciarBtn.disabled = false;
  }
}

/* Al comenzar partida: pasar a la pantalla de juego con los jugadores configurados */
function comenzarPartida(){
  // armar estructura de jugadores
  const selects = Array.from(document.querySelectorAll("select[id^='faccionSelect_']"));
  const jugadores = selects.map((s, idx) => {
    const card = s.closest('.jugador');
    const nombre = card.querySelector('.nombre-j').value || s.value || `Jugador ${idx+1}`;
    const fac = facciones.find(f => f.nombre === s.value);
    return {
      nombre,
      faccion: s.value,
      color: fac ? fac.color : '#777',
      alcanceBase: fac ? fac.alcanceBase : 0
    };
  });

  // guardamos max puntos
  const maxP = parseInt(maxPuntosInput.value) || 30;
  maxPuntosJuegoSpan.textContent = maxP;

  // construir pantalla de juego
  tableroJuego.innerHTML = '';
  mensajeGanadorDiv.classList.remove('activo');
  mensajeGanadorDiv.textContent = '';

  jugadores.forEach((j, idx) => {
    const div = document.createElement('div');
    div.className = 'jugador-juego';
    div.style.background = j.color;
    // texto claro u oscuro según contraste
    const textoClaro = esColorOscuro(j.color) ? '#fff' : '#000';
    div.dataset.faccion = j.faccion;

    const nombreInput = document.createElement('input');
    nombreInput.className = 'nombre-juego';
    nombreInput.type = 'text';
    nombreInput.value = j.nombre;
    nombreInput.style.color = textoClaro;
    nombreInput.style.background = 'transparent';


const puntosDiv = document.createElement('div');
puntosDiv.className = 'puntos';
puntosDiv.textContent = '0';

// nuevos botones a los lados del número
const botones = document.createElement('div');
botones.className = 'botones';
const btnMenos = document.createElement('button');
btnMenos.type = 'button';
btnMenos.className = 'btn-menos';
btnMenos.textContent = '−'; // signo largo
const btnMas = document.createElement('button');
btnMas.type = 'button';
btnMas.className = 'btn-mas';
btnMas.textContent = '+';
btnMenos.style.color = textoClaro;
btnMas.style.color = textoClaro;
puntosDiv.style.color = textoClaro;


// orden: menos - puntos - mas
botones.appendChild(btnMenos);
botones.appendChild(puntosDiv);
botones.appendChild(btnMas);

// añadimos solo nombreInput + botones (sin facLabel)
div.appendChild(nombreInput);
div.appendChild(botones);


    tableroJuego.appendChild(div);

    // listeners para +/- (controlan puntos y ganadores)
    btnMas.addEventListener('click', ()=>{
      let pts = parseInt(puntosDiv.textContent) || 0;
      pts++;
      puntosDiv.textContent = pts;
      chequearGanador();
      guardarEstadoJuego();
    });
    btnMenos.addEventListener('click', ()=>{
      let pts = parseInt(puntosDiv.textContent) || 0;
      pts = Math.max(0, pts-1);
      puntosDiv.textContent = pts;
      guardarEstadoJuego();
    });
  });

  // cambiar pantalla
  pantallaConfig.classList.remove('activa');
  pantallaConfig.classList.add('pantalla');
  pantallaJuego.classList.remove('pantalla');
  pantallaJuego.classList.add('activa');
}

/* Chequeo ganador: si alguien llega al maxPuntos, mostrar mensaje */
function chequearGanador(){
  const maxP = parseInt(maxPuntosInput.value) || 30;
  const puntos = Array.from(document.querySelectorAll('#tableroJuego .puntos')).map(d=>parseInt(d.textContent)||0);
  const ganadorIdx = puntos.findIndex(p=>p >= maxP);
  if(ganadorIdx !== -1){
    const nombres = Array.from(document.querySelectorAll('#tableroJuego .nombre-juego')).map(n=>n.value);
    const ganador = nombres[ganadorIdx] || `Jugador ${ganadorIdx+1}`;
    mensajeGanadorDiv.textContent = ` ¡${ganador} ganó la partida con ${puntos[ganadorIdx]} puntos! `;
    mensajeGanadorDiv.classList.add('activo');
    // opcional: desactivar botones (si vos querés que siga el juego sacalo)
    Array.from(document.querySelectorAll('#tableroJuego .botones button')).forEach(b => b.disabled = true);
  }
}
/* guardar estado del juego en localStorage */
function guardarEstadoJuego() {
    const jugadores = Array.from(document.querySelectorAll('#tableroJuego .jugador-juego')).map(j => {
        return {
            nombre: j.querySelector('.nombre-juego').value,
            faccion: j.dataset.faccion,
            color: j.style.background,
            puntos: parseInt(j.querySelector('.puntos').textContent) || 0
        };
    });
    const maxP = parseInt(maxPuntosInput.value) || 30;
    const numJugadores = parseInt(numJugadoresSelect.value);
    const validarAlcance = switchAlcance.checked;
    
    const estado = { jugadores, maxP, numJugadores, validarAlcance };
    localStorage.setItem('rootJuego', JSON.stringify(estado));
}

/* volver a configuracion */
function volverAConfig(){
  localStorage.removeItem('rootJuego'); // limpiar el estado guardado
  
  pantallaJuego.classList.remove('activa');
  pantallaJuego.classList.add('pantalla');
  pantallaConfig.classList.remove('pantalla');
  pantallaConfig.classList.add('activa');
  mensajeGanadorDiv.classList.remove('activo');
  mensajeGanadorDiv.textContent = '';
  generarTablero();
}

/* iniciar */
generarTablero();

/* Exponer una función por si querés recargar desde consola */
window.regenerar = generarTablero;
// Restaurar juego al recargar la página
window.addEventListener('load', ()=>{
  const estado = localStorage.getItem('rootJuego');
  if(estado){
    const data = JSON.parse(estado);

    // Restaurar configuración
    maxPuntosInput.value = data.maxP || 30;
    numJugadoresSelect.value = data.numJugadores || 4;
    switchAlcance.checked = data.validarAlcance ?? true;

    // Generar tablero según cantidad de jugadores
    generarTablero();

    // Restaurar nombres y facciones
    data.jugadores.forEach((j, idx)=>{
      const select = document.querySelector(`#faccionSelect_${idx}`);
      const card = select.closest('.jugador');
      card.querySelector('.nombre-j').value = j.nombre;
      select.value = j.faccion || ''; 
      // Restaurar pantalla de juego si había puntos guardados
if(data.jugadores.some(j => j.puntos > 0)) {
    comenzarPartida();  // reconstruye la pantalla de juego

    const puntosDivsJuego = Array.from(document.querySelectorAll('#tableroJuego .puntos'));
    data.jugadores.forEach((j, idx) => {
        if(puntosDivsJuego[idx]) puntosDivsJuego[idx].textContent = j.puntos || 0;
        const jugadorDiv = document.querySelector(`#tableroJuego .jugador-juego:nth-child(${idx+1})`);
        if(jugadorDiv) jugadorDiv.dataset.faccion = j.faccion;
    });
  
    chequearGanador();
}
    });

    manejarCambio();

    // Si hay puntos guardados, restaurarlos
    const puntosDivs = Array.from(document.querySelectorAll('#tablero .puntos'));
    puntosDivs.forEach((pDiv, idx)=>{
      if(data.jugadores[idx]) pDiv.textContent = data.jugadores[idx].puntos || '';
    });

    // La pantalla queda en configuración, no saltamos automáticamente a juego
  }
});


</script>


<!-- Botón premium flotante -->
<button id="openPreparations" aria-haspopup="dialog" aria-controls="prepWindow"
  style="position:fixed;right:18px;top:18px;z-index:1200;
         background:linear-gradient(180deg,#2b3948,#16202a);
         color:#fff;border:0;padding:10px 14px;border-radius:14px;
         box-shadow:0 8px 24px rgba(2,6,23,0.6);cursor:pointer;font-weight:700;">
  Preparaciones
</button>

<!-- Overlay (gris translúcido + blur) -->
<div id="prepOverlay" style="position:fixed;inset:0;backdrop-filter:blur(6px);
     background:rgba(8,10,12,0.45);z-index:1100;opacity:0;pointer-events:none;
     transition:opacity .22s ease;"></div>

<!-- Ventana central: lista de facciones -->
<div id="prepWindow" role="dialog" aria-modal="true" aria-hidden="true"
     style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;
            z-index:1201;pointer-events:none;">
  <div id="prepCard" style="width:min(720px,94%);max-height:80vh;overflow:hidden;
       background:linear-gradient(180deg, rgba(12,14,16,0.96), rgba(18,20,23,0.96));
       border-radius:18px;padding:18px;box-shadow:0 20px 60px rgba(2,6,23,0.7);
       transform:translateY(18px) scale(.98);opacity:0;transition:all .22s ease;
       backdrop-filter: blur(8px);pointer-events:auto;display:flex;flex-direction:column;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
      <h3 style="margin:0;color:#fff;font-size:1.15rem;font-weight:800;">Preparaciones — Elegir facción</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <a href="https://root.seiyria.com/" target="_blank" rel="noopener"
           style="color:#7fc7ff;text-decoration:underline;font-weight:700;font-size:0.95rem;">
           Reglas del juego
        </a>
        <button id="closePrep" aria-label="Cerrar preparaciones"
                style="background:transparent;border:0;color:#bfc8d3;font-weight:800;cursor:pointer;font-size:1.05rem;">
          ✕
        </button>
      </div>
    </div>

    <div style="flex:1;display:flex;gap:14px;align-items:stretch;">
      <!-- lista -->
      <div id="prepListWrapper" style="width:48%;max-height:58vh;overflow:auto;padding-right:8px;">
        <div id="prepList" style="display:flex;flex-direction:column;gap:10px;"></div>
      </div>

      <!-- panel preview pequeño (inicial vacío) -->
      <div id="previewPanel" style="width:52%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
           border-radius:12px;padding:12px;color:#e9eef3;display:flex;flex-direction:column;
           gap:10px;align-items:flex-start;overflow:auto;max-height:58vh;">
        <div id="previewTitle" style="font-weight:800;font-size:1.05rem;color:#fff;">Selecciona una facción</div>
        <div id="previewMode" style="font-size:0.95rem;color:#a9b6c6;">Modo: —</div>
        <div id="previewText" style="white-space:pre-line;color:#dfeaf6;font-size:0.92rem;line-height:1.35;">
          Aquí aparecerán los pasos de preparación seleccionados.
        </div>
        <div style="margin-top:auto;width:100%;display:flex;justify-content:space-between;align-items:center;">
          <a id="previewRulesLink" href="https://root.seiyria.com/" target="_blank"
             style="color:#7fc7ff;text-decoration:underline;font-weight:700;">Reglas del juego</a>
          <button id="closePreview" style="background:#1f2a33;border:0;color:#cfe8ff;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700;">
            Cerrar
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Detalle grande (reemplaza la vista, estilo "ganador") -->
<div id="prepDetailModal" role="dialog" aria-modal="true" aria-hidden="true"
     style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;z-index:1300;
            pointer-events:none;">
  <div style="width:min(760px,94%);background:linear-gradient(180deg, rgba(6,8,10,0.98), rgba(18,20,22,0.98));
              border-radius:18px;padding:22px;box-shadow:0 28px 80px rgba(0,0,0,0.7);
              color:#fff;transform:translateY(10px) scale(.99);opacity:0;transition:all .22s ease;pointer-events:auto;">
    <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px;">
      <div>
        <div id="detailTitle" style="font-size:1.25rem;font-weight:900;">Título facción</div>
        <div id="detailMode" style="color:#9fb6cf;font-weight:700;font-size:0.95rem;">Modo</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center;">
        <a id="detailRules" href="https://root.seiyria.com/" target="_blank" style="color:#7fc7ff;font-weight:800;text-decoration:underline;">
          Reglas del juego
        </a>
        <button id="closeDetail" aria-label="Cerrar detalle" style="background:#1a242b;border:0;color:#dceefc;padding:8px 12px;border-radius:12px;cursor:pointer;font-weight:800;">
          Cerrar
        </button>
      </div>
    </div>

    <div id="detailBody" style="max-height:58vh;overflow:auto;color:#e6f3ff;line-height:1.45;white-space:pre-line;padding-right:6px;"></div>
  </div>
</div>

<!-- Estilos del scrollbar local para estas ventanas -->
<style>
  /* scrollbar para los paneles */
  #prepListWrapper::-webkit-scrollbar, #prepDetailModal div::-webkit-scrollbar, #previewPanel::-webkit-scrollbar {
    width:8px;
  }
  #prepListWrapper::-webkit-scrollbar-thumb, #previewPanel::-webkit-scrollbar-thumb, #prepDetailModal div::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.06); border-radius:8px;
  }
  /* fila de facción: división rectángulo */
  .prep-row {
    display:flex;align-items:center;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:10px;overflow:hidden;padding:6px;border:1px solid rgba(255,255,255,0.03);
  }
  .prep-name { padding:8px 10px;font-weight:800;color:#f4fbff;flex:1; }
  .prep-actions { display:flex; width:220px; height:42px; border-radius:8px; overflow:hidden; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);}
  .prep-actions button { flex:1;border:0;background:transparent;color:#dceffb;font-weight:800;cursor:pointer;font-size:0.92rem; }
  .prep-actions button.left { background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-right:1px solid rgba(255,255,255,0.03); }
  .prep-actions button.right { background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02)); }
  .prep-actions button:hover { background:rgba(255,255,255,0.03); }
</style>


<script>
/* ====== Datos (usa tu texto completo) ====== */
const prepData = {
  "Marquesado": {
    normal: `Colocar la Fortaleza: Coloca la ficha de la fortaleza en un claro de una esquina a tu elección. Este es tu claro inicial.
Guarnición: Coloca un guerrero en cada claro excepto el claro diagonalmente opuesto.
Edificios Iniciales: Coloca 1 aserradero, 1 taller y 1 reclutador en tu claro inicial o adyacentes.
Rellenar Contadores: Coloca los contadores restantes de derecha a izquierda, dejando el más a la izquierda vacío.`,
    avanzada: `Elige tres claros de hogar adyacentes.
Coloca 3 guerreros en cada hogar y 1 en cada otro claro.
Coloca la ficha de Torreón en uno de tus hogares (no adyacente a un hogar enemigo si es posible).
Coloca 1 aserradero, 1 taller y 1 reclutador en cada claro de hogar diferente.
Llena tu registro de Edificios con tus edificios excepto los espacios de más a la izquierda.`
  },
  "Nido de Aguilas": {
    normal: `Coloca 1 nido y 6 guerreros en un claro de esquina no ocupado.
Elige 1 carta de líder y colócala en tu espacio.
Coloca tus 2 Visires Leales según tu líder.
Rellena el contador de nidos de derecha a izquierda.`,
    avanzada: `Elige un claro de hogar en el borde con 3+ claros entre él y hogares enemigos.
Pon 6 guerreros y 1 nido en tu hogar.
Coloca cualquier carta de Líder en tu espacio.
Mete 2 Visires Leales bajo el espacio de columnas del Decreto según tu líder.
Llena tus espacios de Nidos, excepto el de más a la izquierda.`
  },
  "Alianza del Bosque": {
    normal: `Coloca 3 bases en tus espacios de bases.
Rellena el contador de simpatía con 10 fichas.
Roba 3 cartas y colócalas bocabajo en tu montón de simpatizantes.`,
    avanzada: `Roba 3 cartas y añádelas boca abajo a tu pila de Partidarios.
Llena tu registro de Simpatía con fichas.
Coloca tus 3 Bases en los espacios correspondientes.`
  },
  "Vagabundo": {
    normal: `Elige una carta de personaje y colócala en tu espacio.
Coloca tu peón en cualquier bosque.
Roba 3 misiones y colócalas bocarriba.
Coloca 4 objetos 'R' bajo las ruinas aleatoriamente.
Coloca los objetos 'S' indicados en tu carta.`,
    avanzada: `Pon tu peón en cualquier bosque.
Baraja el mazo de misiones y roba 3 cartas.
Pon 4 objetos 'R' bajo las ruinas aleatoriamente.
Pon la carta de personaje y los objetos 'S' según sea necesario.
Coloca marcadores de relación para facciones no-Vagabundo.`
  },
  "Compañía del Río": {
    normal: `Coloca 4 guerreros en claros conectados al río.
Rellena los contadores de puestos comerciales.
Coloca 3 guerreros en zona de pagos.
Coloca 1 marcador de servicio en cada contador.`,
    avanzada: `Pon 4 guerreros entre claros a lo largo del río.
Pon 3 guerreros en tu caja de Pagos.
Llena los registros de Puestos de Comercio.
Pon 3 marcadores de servicio en tu registro, estableciendo precios.`
  },
  "Culto Reptiliano": {
    normal: `Coloca 4 guerreros y 1 jardín en un claro de esquina no ocupado.
Coloca 1 guerrero en cada claro adyacente.
Coloca el marcador de paria en su lugar.
Rellena los contadores de jardines.`,
    avanzada: `Elige un claro que no sea adyacente a hogares enemigos.
Pon 4 guerreros y 1 jardín en tu hogar.
Pon 2 guerreros en claros adyacentes.
Pon 2 guerreros en tu caja de Acólitos.
Llena tus registros de Jardines, excepto el espacio más a la izquierda.`
  },
  "Ducado Subterráneo": {
    normal: `Coloca el tablero de la madriguera cerca del mapa.
Coloca 2 guerreros y 1 túnel en un claro de esquina no ocupado.
Rellena marcadores de edificios (ciudadelas y mercados).
Coloca 9 cartas de ministro bocarriba y 9 coronas en sus espacios.`,
    avanzada: `Elige un claro que no sea adyacente a enemigos.
Pon 6 guerreros y 1 túnel en tu hogar.
Pon 3 guerreros entre los claros adyacentes.
Coloca tablero de Madriguera cerca y llena registros de edificios.
Coloca cartas de ministros y 9 coronas.`
  },
  "Conspiración Córvida": {
    normal: `Coloca 1 guerrero en un claro de cada palo (3 en total).`,
    avanzada: `Elige un claro de hogar.
Pon 1 guerrero y 1 ficha de trama boca abajo.
Pon 1 guerrero en un claro de cada palo (4 guerreros en total).`
  },
  "Señor de los Cientos": {
    normal: `Coloca tu señor, 4 guerreros y 1 bastión en un claro de esquina.
Coloca los 4 objetos 'R' aleatoriamente bajo las ruinas.
Coloca la carta de estado de ánimo Obstinado.`,
    avanzada: `Elige un claro de hogar en el borde con 3+ claros entre él y hogares enemigos.
Pon tu caudillo, 4 guerreros y 1 fortaleza.
Coloca la carta de humor Obstinado y los 4 objetos 'R' bajo ruinas.`
  },
  "Guardianes de Hierro": {
    normal: `Baraja las 12 fichas de reliquia y coloca una en cada bosque boca abajo.
Forma la reserva de guerreros (15).
Coloca 4 guerreros en cada hogar elegido.
Distribuye las reliquias restantes equitativamente.
Coloca una carta de Seguidor Fiel en cada espacio del Séquito.`,
    avanzada: `Baraja 12 fichas de reliquia.
Elige 2 claros de hogar adyacentes en el borde.
Pon 4 guerreros en cada hogar.
Distribuye las reliquias restantes.
Coloca una carta de Vasallo Fiel en cada espacio de columna.`
  }
};

/* ====== Elementos DOM ====== */
const openBtn = document.getElementById('openPreparations');
const overlay = document.getElementById('prepOverlay');
const prepWindow = document.getElementById('prepWindow');
const prepCard = document.getElementById('prepCard');
const prepList = document.getElementById('prepList');
const closePrep = document.getElementById('closePrep');
const previewTitle = document.getElementById('previewTitle');
const previewMode = document.getElementById('previewMode');
const previewText = document.getElementById('previewText');
const previewRules = document.getElementById('previewRulesLink');
const closePreview = document.getElementById('closePreview');

const detailModal = document.getElementById('prepDetailModal');
const detailTitle = document.getElementById('detailTitle');
const detailMode = document.getElementById('detailMode');
const detailBody = document.getElementById('detailBody');
const closeDetail = document.getElementById('closeDetail');
const detailRules = document.getElementById('detailRules');

/* ====== Utilidades ====== */
function showWindow() {
  overlay.style.opacity = '1';
  overlay.style.pointerEvents = 'auto';
  prepWindow.style.pointerEvents = 'auto';
  prepCard.style.opacity = '1';
  prepCard.style.transform = 'translateY(0) scale(1)';
  prepWindow.setAttribute('aria-hidden','false');
}
function hideWindow() {
  overlay.style.opacity = '0';
  overlay.style.pointerEvents = 'none';
  prepWindow.style.pointerEvents = 'none';
  prepCard.style.opacity = '0';
  prepCard.style.transform = 'translateY(18px) scale(.98)';
  prepWindow.setAttribute('aria-hidden','true');
  // limpiar preview
  previewTitle.textContent = 'Selecciona una facción';
  previewMode.textContent = 'Modo: —';
  previewText.textContent = 'Aquí aparecerán los pasos de preparación seleccionados.';
}
function showDetail() {
  detailModal.style.pointerEvents = 'auto';
  const modalInner = detailModal.querySelector('div');
  modalInner.style.opacity = '1';
  modalInner.style.transform = 'translateY(0)';
  detailModal.setAttribute('aria-hidden','false');
}
function hideDetail() {
  detailModal.style.pointerEvents = 'none';
  const modalInner = detailModal.querySelector('div');
  modalInner.style.opacity = '0';
  modalInner.style.transform = 'translateY(10px)';
  detailModal.setAttribute('aria-hidden','true');
}

/* ====== Construir lista dinamica ====== */
function montarLista() {
  prepList.innerHTML = '';
  Object.keys(prepData).forEach(faction => {
    const row = document.createElement('div');
    row.className = 'prep-row';

    const name = document.createElement('div');
    name.className = 'prep-name';
    name.textContent = faction;

    const actions = document.createElement('div');
    actions.className = 'prep-actions';

    const btnNormal = document.createElement('button');
    btnNormal.className = 'left';
    btnNormal.textContent = 'Normal';
    btnNormal.dataset.faction = faction;
    btnNormal.dataset.mode = 'normal';

    const btnAvanz = document.createElement('button');
    btnAvanz.className = 'right';
    btnAvanz.textContent = 'Avanzada';
    btnAvanz.dataset.faction = faction;
    btnAvanz.dataset.mode = 'avanzada';

    actions.appendChild(btnNormal);
    actions.appendChild(btnAvanz);

    row.appendChild(name);
    row.appendChild(actions);
    prepList.appendChild(row);
  });

  // enlace al final (Reglas)
  const rulesRow = document.createElement('div');
  rulesRow.style.textAlign = 'center';
  rulesRow.style.marginTop = '8px';
  rulesRow.innerHTML = `<a href="https://root.seiyria.com/" target="_blank" style="color:#7fc7ff;font-weight:800;text-decoration:underline;">Reglas del juego</a>`;
  prepList.appendChild(rulesRow);
}

/* ====== Eventos ====== */
openBtn.addEventListener('click', () => {
  montarLista();
  showWindow();
});

closePrep.addEventListener('click', hideWindow);
overlay.addEventListener('click', () => { hideWindow(); hideDetail(); });

prepList.addEventListener('click', (e) => {
  const btn = e.target.closest('button');
  if (!btn) return;
  const faction = btn.dataset.faction;
  const mode = btn.dataset.mode;
  const text = prepData[faction] && prepData[faction][mode] ? prepData[faction][mode] : 'No hay datos.';
  // actualizar preview
  previewTitle.textContent = faction;
  previewMode.textContent = (mode === 'normal') ? 'Modo: Preparación Básica' : 'Modo: Preparación Avanzada';
  previewText.textContent = text;
  previewRules.href = 'https://root.seiyria.com/';
  // abrir detalle grande (reemplaza)
  detailTitle.textContent = faction;
  detailMode.textContent = (mode === 'normal') ? 'Preparación Básica' : 'Preparación Avanzada';
  detailBody.textContent = text;
  detailRules.href = 'https://root.seiyria.com/';
  // animación: cerrar tarjeta y abrir detalle
  hideWindow();
  setTimeout(() => { showDetail(); }, 180);
});

closePreview.addEventListener('click', () => { hideWindow(); hideDetail(); });
closeDetail.addEventListener('click', () => { hideDetail(); showWindow(); });

/* cuando se presiona ESC cerrar modales */
document.addEventListener('keydown', (ev) => {
  if (ev.key === 'Escape') {
    hideDetail();
    hideWindow();
  }
});

/* inicialización: detalle oculto */
hideWindow();
hideDetail();
</script>




</body>
</html>






















